<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE ALARMA RS ART</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Firebase App y Database -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { background: #0f091a; color: white; font-family: sans-serif; text-align: center; }
        .btn-timbre { 
            width: 200px; height: 200px; background: #e91e63; border-radius: 50%; 
            margin: 50px auto; display: flex; align-items: center; justify-content: center;
            font-size: 2rem; font-weight: bold; cursor: pointer; border: 8px solid white;
            box-shadow: 0 0 50px #e91e63; transition: 0.3s;
        }
        .btn-timbre:active { transform: scale(0.9); }
        .status-box { padding: 10px; margin: 10px; border-radius: 10px; font-size: 0.8rem; }
        .alarm-on { animation: flash 0.3s infinite; }
        @keyframes flash { 
            0% { background: red; } 50% { background: blue; } 100% { background: red; } 
        }
    </style>
</head>
<body id="cuerpo">

    <h1 class="text-3xl font-black mt-10 text-lime-400">RS ART ALARM</h1>
    
    <!-- SEM√ÅFORO DE ESTADO -->
    <div id="conexionInfo" class="status-box bg-gray-800 text-gray-400">
        Estado: <span id="puntos">Intentando conectar con Firebase...</span>
    </div>

    <!-- BOT√ìN DE TIMBRE -->
    <div class="btn-timbre" onclick="tocarTimbre()">üîî TIMBRE</div>

    <!-- BOT√ìN ADMIN -->
    <button onclick="modoAdmin()" class="mt-10 text-gray-500 underline">Configuraci√≥n de Admin</button>

    <!-- PANEL ADMIN -->
    <div id="panelAdmin" class="hidden mt-10 p-5 border border-dashed border-lime-500 mx-5 rounded-xl">
        <h2 class="text-xl font-bold text-lime-400">MODO MONITOR ACTIVO</h2>
        <p class="text-sm">Esta PC sonar√° cuando alguien toque el timbre.</p>
        <button onclick="desbloquearSonido()" class="bg-lime-500 text-black font-bold p-4 rounded-full mt-4 w-full">
            1. CLIC AQU√ç PARA ACTIVAR SONIDO
        </button>
        <button onclick="apagarAlarma()" id="btnApagar" class="hidden bg-white text-red-600 font-bold p-4 rounded-full mt-4 w-full">
            2. APAGAR ALARMA
        </button>
    </div>

    <!-- AUDIO -->
    <audio id="sonidoSirena" loop>
        <source src="https://www.soundjay.com/buttons/sounds/beep-01a.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ========================================================
        // CONFIGURACI√ìN - PEGA TU URL DE FIREBASE AQU√ç ABAJO
        // ========================================================
        const firebaseConfig = {
            databaseURL: "https://rs-art-timbre-default-rtdb.firebaseio.com/" 
        };
        // ========================================================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. COMPROBAR CONEXI√ìN
        const statusText = document.getElementById('puntos');
        db.ref('.info/connected').on('value', (snap) => {
            if (snap.val() === true) {
                statusText.innerText = "CONECTADO A FIREBASE OK ‚úÖ";
                statusText.style.color = "#C6FF00";
            } else {
                statusText.innerText = "ERROR: No hay conexi√≥n a Firebase ‚ùå";
                statusText.style.color = "red";
            }
        });

        // 2. FUNCI√ìN DEL CLIENTE (TOCAR TIMBRE)
        function tocarTimbre() {
            db.ref('alarma_evento').set({
                id: Math.floor(Math.random() * 99999), // ID aleatorio para forzar el cambio
                timestamp: Date.now()
            }).then(() => {
                Swal.fire('¬°Timbre enviado!', 'El administrador est√° escuchando.', 'success');
            }).catch(err => {
                Swal.fire('Error', 'No tienes permiso en Firebase. Revisa las reglas.', 'error');
            });
        }

        // 3. FUNCI√ìN DEL ADMIN (PC)
        function modoAdmin() {
            const pass = prompt("Introduce clave admin:");
            if (pass === "2025") {
                document.getElementById('panelAdmin').style.removeProperty('display');
                document.getElementById('panelAdmin').style.display = "block";
            }
        }

        function desbloquearSonido() {
            const audio = document.getElementById('sonidoSirena');
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
                escucharTimbre();
                Swal.fire('Monitor Listo', 'La PC ya puede sonar.', 'success');
            });
        }

        function escucharTimbre() {
            db.ref('alarma_evento').on('value', (snapshot) => {
                const audio = document.getElementById('sonidoSirena');
                const cuerpo = document.getElementById('cuerpo');
                const btnA = document.getElementById('btnApagar');
                
                // Si hay un evento nuevo (el timestamp cambi√≥)
                console.log("Evento recibido en Firebase");
                audio.play();
                cuerpo.classList.add('alarm-on');
                btnA.classList.remove('hidden');
            });
        }

        function apagarAlarma() {
            const audio = document.getElementById('sonidoSirena');
            audio.pause();
            audio.currentTime = 0;
            document.getElementById('cuerpo').classList.remove('alarm-on');
            document.getElementById('btnApagar').classList.add('hidden');
        }
    </script>
</body>
</html>
